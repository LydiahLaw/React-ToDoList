pipeline {
    agent any

    parameters {
        booleanParam(
            name: 'SKIP_INFRA',
            defaultValue: true,
            description: 'Skip EKS cluster creation if it already exists'
        )
    }

    environment {
        FRONTEND_IMAGE = 'peterukpabi4/eks-react-todo'
        BACKEND_IMAGE  = 'peterukpabi4/eks-react-todo-backend'
        TAG = "${BUILD_NUMBER}"

        AWS_DEFAULT_REGION = 'us-east-1'

        EKS_CLUSTER_NAME = 'dive-app-cluster'
        EKS_REGION = 'us-east-1'

        FRONTEND_APP = 'react-todo-frontend'
        BACKEND_APP  = 'react-todo-backend'
        MONGO_APP    = 'mongo'
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Terraform - Create/Update EKS Cluster') {
            when { expression { params.SKIP_INFRA == false } }
            steps {
                withCredentials([
                    [$class: 'AmazonWebServicesCredentialsBinding',
                     credentialsId: 'aws-credentials']
                ]) {
                    dir('eks-terraform') {
                        sh '''
                        export AWS_DEFAULT_REGION=us-east-1

                        aws sts get-caller-identity

                        terraform init
                        terraform validate
                        terraform plan -out=tfplan
                        terraform apply -auto-approve tfplan
                        '''
                    }
                }
            }
        }

        stage('Configure AWS and EKS') {
            steps {
                withCredentials([
                    [$class: 'AmazonWebServicesCredentialsBinding',
                     credentialsId: 'aws-credentials']
                ]) {
                    sh '''
                    export AWS_DEFAULT_REGION=us-east-1

                    aws sts get-caller-identity

                    aws eks update-kubeconfig \
                      --region us-east-1 \
                      --name dive-app-cluster

                    kubectl cluster-info
                    kubectl get nodes
                    '''
                }
            }
        }

        stage('Docker Login') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                    echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                dir('dive-react-app') {
                    sh "docker build -t ${FRONTEND_IMAGE}:${TAG} ."
                }
                dir('backend') {
                    sh "docker build -t ${BACKEND_IMAGE}:${TAG} ."
                }
            }
        }

        stage('Push Docker Images') {
            steps {
                sh '''
                docker push ${FRONTEND_IMAGE}:${TAG}
                docker push ${BACKEND_IMAGE}:${TAG}
                '''
            }
        }

        stage('Deploy Application to EKS') {
            steps {
                dir('eks-terraform') {
                    sh '''
                    sed -i "s|image: .*eks-react-todo.*|image: ${FRONTEND_IMAGE}:${TAG}|" frontend.yaml
                    sed -i "s|image: .*eks-react-todo-backend.*|image: ${BACKEND_IMAGE}:${TAG}|" backend.yaml

                    kubectl apply -f configmap.yaml
                    kubectl apply -f secret.yaml
                    kubectl apply -f mongo-deployment.yaml
                    kubectl apply -f mongo-service.yaml
                    kubectl apply -f frontend.yaml
                    kubectl apply -f backend.yaml

                    kubectl rollout status deployment/${FRONTEND_APP} --timeout=300s
                    kubectl rollout status deployment/${BACKEND_APP} --timeout=300s
                    kubectl rollout status deployment/${MONGO_APP} --timeout=300s
                    '''
                }
            }
        }
    }

    post {
        success {
            echo '✅ Pipeline completed successfully!'
            sh 'kubectl get pods && kubectl get svc'
        }
        failure {
            echo '❌ Pipeline failed!'
        }
        always {
            sh 'docker logout'
            archiveArtifacts artifacts: '**/*.yaml', allowEmptyArchive: true
        }
    }
}
